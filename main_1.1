#!/bin/bash

######################################################################
##              Set Up Script for Kali on Bootable USB               ##
######################################################################
# This is a set up script for setting up preferred aps on a USB which already has 
# basic Kalie installed - without persistence.

# to install:-
#   change to root user using -->> sudo bash && sudo bash && cd ~
#   need to first install curl ==> apt install curl  # this is probably already on?
#   then
#   curl -k -s https://raw.githubusercontent.com/leighton-0/Kail_SetUp/main/main_1 | bash
#   install using -->> wget https://raw.githubusercontent.com/leighton-0/Kail_SetUp/main/main_1.1 && chmod +x main_1.1
#   Run using ./main_1.1

s=5                  # Slows script down so you can see whats going on.

# will the persistence script below work in zsh (defalt kali shiell)
# assume you have to change shell --> add persistece --> reboot & cnange shell again

<< 'MULTILINE-COMMENT'
printf '\n============================================================\n'
printf '[+] Change to root \n'
printf '============================================================\n\n'
sudo bash
curl https://raw.githubusercontent.com/leighton-0/Kail_SetUp/main/main_1 && chmod +x main_1.1
cd ~
printf "Presently logged in as - %s\n"  whoami
whoami
printf "Present working directory is - %s\n" pwd
pwd
sleep 10


printf '\n============================================================\n'
printf '[+] change shell from zsh to bash \n'
printf '============================================================\n\n'
sleep $s
printf "My current shell - %s\n" "$SHELL"
chsh -s /bin/bash                         ## change to bash to bash shell ##
printf "My current shell in now - %s\n" "$SHELL"
sleep 10
MULTILINE-COMMENT

printf '\n============================================================\n'
printf '[+] Set Up Persistence on Kali\n'
printf '============================================================\n\n'
sleep $10

usb=/dev/sdb
fdisk $usb <<< $(printf "n\np\n\n\n\nw")
# create an ext4 file system in the partition and label it persistence:
usb=/dev/sdb
mkfs.ext4 -L persistence ${usb}3
# Create a mount point, mount the new partition there, and then create the configuration file to enable persistence. Finally, unmount the partition:
usb=/dev/sdb
mkdir -p /mnt/my_usb
mount ${usb}3 /mnt/my_usb
echo "/ union" | sudo tee /mnt/my_usb/persistence.conf
umount ${usb}3


<< 'MULTILINE-COMMENT'
# ==create a partition above the Kali Live partitions==
sudo fdisk -l
sleep 10
printf '\n=================\n'
end=7GiB
read start _ < <(du -bcm kali-linux-2021.1-live-arm64.iso | tail -1); echo $start
parted /dev/sdb mkpart primary ${start}MiB $end
sudo fdisk -l
sleep 20

#  ==to create an ext3 file system labeled "persistence."==
mkfs.ext3 -L persistence /dev/sdb3
e2label /dev/sdb3 persistence

# create a mount point, 
# mount the new partition there, 
# create a configuration file to enable persistence, then 
# unmount the partition.
mkdir -p /mnt/my_usb
mount /dev/sdb3 /mnt/my_usb
echo "/ union" > /mnt/my_usb/persistence.conf
umount /dev/sdb3

reboot

# wget the autoexpect file now that we have persistence

printf '\n============================================================\n'
printf '[+] change shell from zsh to bash \n'
printf '============================================================\n\n'
sleep $s

printf "My current shell - %s\n" "$SHELL"
chsh -s /bin/bash                         ## change to bash to bash shell ##
printf "My current shell in now - %s\n" "$SHELL"

printf '\n============================================================\n'
printf '[+] Enable the root account with a password of toor \n'
printf '============================================================\n\n'
sudo passwd
echo kali
echo toor
echo toor


==========================
MULTILINE-COMMENT
